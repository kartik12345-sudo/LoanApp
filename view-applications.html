<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Applications - FinanceFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        get,
        remove,
        update,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBIIjb6cX-li0NghqRtZ0lzRE2IO4v4MoQ",
        authDomain: "loanappapi.firebaseapp.com",
        databaseURL: "https://loanappapi-default-rtdb.firebaseio.com",
        projectId: "loanappapi",
        storageBucket: "loanappapi.firebasestorage.app",
        messagingSenderId: "879738907563",
        appId: "1:879738907563:web:05d15179b6a97a1f0140ee",
        measurementId: "G-NJTEPTQ27V",
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      const analytics = getAnalytics(app);

      // Make database functions available globally
      window.firebaseDB = database;
      window.firebaseRef = ref;
      window.firebaseGet = get;
      window.firebaseRemove = remove;
      window.firebaseUpdate = update;
    </script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");

      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .glass-morphism {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
      }

      .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-content {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      }

      .star-filled {
        color: #fbbf24;
        filter: drop-shadow(0 2px 4px rgba(251, 191, 36, 0.3));
      }

      .star-empty {
        color: #d1d5db;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .access-denied {
        text-align: center;
        padding: 4rem 2rem;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      }

      .application-card {
        background: linear-gradient(145deg, #ffffff, #f8fafc);
        border: 1px solid #e2e8f0;
        border-radius: 20px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .application-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #3b82f6, #8b5cf6, #3b82f6);
        background-size: 200% 100%;
        animation: shimmer 3s ease-in-out infinite;
      }

      @keyframes shimmer {
        0%,
        100% {
          background-position: 200% 0;
        }
        50% {
          background-position: -200% 0;
        }
      }

      .application-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.15);
      }

      .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.875rem;
        letter-spacing: 0.025em;
      }

      .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.6);
      }

      .action-button {
        padding: 12px;
        border-radius: 12px;
        transition: all 0.3s ease;
        border: 2px solid transparent;
      }

      .action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
      }

      .floating-card {
        animation: float 6s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .approval-checkbox {
        width: 24px;
        height: 24px;
        border: 3px solid #10b981;
        border-radius: 6px;
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .approval-checkbox.checked {
        background: linear-gradient(135deg, #10b981, #059669);
        border-color: #059669;
      }

      .approval-checkbox.checked::after {
        content: "✓";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-weight: bold;
        font-size: 14px;
      }

      .filter-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body class="min-h-screen">
    <header class="glass-morphism sticky top-0 z-50 border-b border-white/20">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <a
            href="index.html"
            class="flex items-center space-x-3 text-xl font-bold text-blue-600 hover:text-blue-700 transition-colors"
          >
            <div class="p-2 bg-blue-100 rounded-lg">
              <i data-lucide="building-2" class="h-6 w-6"></i>
            </div>
            <span
              class="bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent"
              >FinanceFlow</span
            >
          </a>

          <nav class="flex space-x-4">
            <a href="apply-loan.html">
              <button
                class="px-6 py-2 text-sm font-medium rounded-full text-gray-700 hover:bg-white/50 transition-all duration-300"
              >
                Apply for Loan
              </button>
            </a>
<a href="view-applications.html">
    <button class="px-6 py-2 text-sm font-medium rounded-full bg-blue-600 text-white shadow-lg">
        View Applications
    </button>
</a>
            <button
              id="staffLoginBtn"
              class="px-6 py-2 text-sm font-medium rounded-full text-gray-700 hover:bg-white/50 transition-all duration-300"
            >
              <span id="staffBtnText">Staff Login</span>
            </button>
          </nav>
        </div>
      </div>
    </header>

    <div
      id="accessDenied"
      class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16"
      style="display: none"
    >
      <div class="access-denied max-w-md mx-auto">
        <div class="animate-bounce mb-6">
          <div
            class="mx-auto w-20 h-20 bg-gradient-to-br from-red-400 to-red-600 rounded-full flex items-center justify-center"
          >
            <i data-lucide="shield-x" class="h-10 w-10 text-white"></i>
          </div>
        </div>
        <h2 class="text-3xl font-bold text-gray-900 mb-4">
          🔒 Access Restricted
        </h2>
        <p class="text-gray-600 mb-8 text-lg">
          This page is only accessible to authorized staff members.
        </p>
        <button
          id="staffLoginFromDenied"
          class="btn-primary text-white px-8 py-4 rounded-2xl font-semibold text-lg"
        >
          🔑 Staff Login Required
        </button>
      </div>
    </div>

    <main id="mainContent" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <div class="space-y-8">
        <div class="text-center text-white mb-8">
          <h1
            class="text-5xl font-bold mb-4 bg-gradient-to-r from-white to-blue-100 bg-clip-text text-transparent"
          >
            📊 Staff Portal - Applications Management
          </h1>
          <p class="text-xl text-blue-100">
            Comprehensive loan application management system
          </p>
        </div>

        <div class="floating-card glass-morphism rounded-3xl p-8 mb-8">
          <div
            class="flex flex-col lg:flex-row justify-between items-center space-y-4 lg:space-y-0"
          >
            <div class="flex items-center space-x-6">
              <div class="text-center">
                <div
                  class="text-3xl font-bold text-blue-600"
                  id="totalApplications"
                >
                  0
                </div>
                <div class="text-sm text-gray-600 font-medium">
                  Total Applications
                </div>
              </div>
              <div class="w-px h-12 bg-gray-300"></div>
              <div class="text-center">
                <div
                  class="text-3xl font-bold text-green-600"
                  id="approvedCount"
                >
                  0
                </div>
                <div class="text-sm text-gray-600 font-medium">Approved</div>
              </div>
              <div class="w-px h-12 bg-gray-300"></div>
              <div class="text-center">
                <div
                  class="text-3xl font-bold text-yellow-600"
                  id="pendingCount"
                >
                  0
                </div>
                <div class="text-sm text-gray-600 font-medium">Pending</div>
              </div>
            </div>
            <button
              id="logoutBtn"
              class="px-6 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all duration-300"
            >
              🚪 Logout
            </button>
          </div>
        </div>

        <div class="filter-card p-6">
          <div class="flex flex-wrap items-center gap-6">
            <div class="flex-1 min-w-80">
              <label
                for="search"
                class="block text-sm font-semibold text-gray-700 mb-2"
                >🔍 Search Applications</label
              >
              <div class="relative">
                <i
                  data-lucide="search"
                  class="absolute left-4 top-4 h-5 w-5 text-gray-400"
                ></i>
                <input
                  type="text"
                  id="search"
                  placeholder="Search by application code or company name..."
                  class="w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all"
                />
              </div>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >📊 Filter Status</label
              >
              <select
                id="filterSelect"
                class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all min-w-40"
              >
                <option value="all">All Applications</option>
                <option value="starred">⭐ Starred Only</option>
                <option value="pending">⏳ Pending</option>
                <option value="approved">✅ Approved</option>
                <option value="rejected">❌ Rejected</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >&nbsp;</label
              >
              <button
                id="refreshBtn"
                class="btn-primary px-6 py-3 text-white rounded-xl font-semibold flex items-center space-x-2"
              >
                <i data-lucide="refresh-cw" class="h-5 w-5"></i>
                <span>Refresh</span>
              </button>
            </div>
          </div>
        </div>

        <div
          id="loadingState"
          class="glass-morphism rounded-3xl text-center py-16"
        >
          <div class="loading mx-auto mb-4"></div>
          <p class="text-gray-600 text-lg">Loading applications...</p>
        </div>

        <div id="applicationsList" class="space-y-6" style="display: none">
          </div>

        <div
          id="noApplications"
          class="glass-morphism rounded-3xl text-center py-16"
          style="display: none"
        >
          <div class="animate-bounce mb-6">
            <i
              data-lucide="building"
              class="h-16 w-16 mx-auto text-gray-400"
            ></i>
          </div>
          <p class="text-xl text-gray-500 font-semibold">
            No applications found
          </p>
          <p class="text-gray-400">
            Applications will appear here once submitted
          </p>
        </div>
      </div>
    </main>

    <div id="staffLoginModal" class="modal">
      <div class="modal-content">
        <div class="p-8">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-900">
              🔐 Staff Login Required
            </h3>
            <button
              id="closeModal"
              class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 transition-all"
            >
              <i data-lucide="x" class="h-6 w-6"></i>
            </button>
          </div>

          <form id="staffLoginForm" class="space-y-6">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >Staff ID</label
              >
              <input
                type="text"
                id="staffId"
                required
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >Password</label
              >
              <input
                type="password"
                id="password"
                required
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all"
              />
            </div>
            <button
              type="submit"
              class="w-full btn-primary text-white py-3 rounded-xl font-semibold text-lg"
            >
              🚀 Login
            </button>
          </form>

          <div
            class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl"
          >
            <p class="text-sm font-semibold text-gray-800 mb-2">
              🔑 Demo Credentials:
            </p>
            <p class="text-sm text-gray-600">
              Staff ID: <span class="font-mono font-bold">admin</span>
            </p>
            <p class="text-sm text-gray-600">
              Password: <span class="font-mono font-bold">password</span>
            </p>
          </div>
        </div>
      </div>
    </div>

    <div id="deleteModal" class="modal">
      <div class="modal-content">
        <div class="p-8">
          <div class="flex items-center mb-6">
            <div
              class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4"
            >
              <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900">
              ⚠️ Delete Application
            </h3>
          </div>
          <p class="text-gray-600 mb-8 text-lg">
            Are you sure you want to delete this application? This action cannot
            be undone and all data will be permanently lost.
          </p>
          <div class="flex space-x-4">
            <button
              id="confirmDelete"
              class="flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg transition-all duration-300"
            >
              🗑️ Delete
            </button>
            <button
              id="cancelDelete"
              class="flex-1 bg-gradient-to-r from-gray-400 to-gray-500 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg transition-all duration-300"
            >
              ❌ Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let applications = [];
      let currentApplicationToDelete = null;
      let isStaffLoggedIn = localStorage.getItem("staffLoggedIn") === "true";

      // Initialize Lucide icons
      lucide.createIcons();

      // Check staff access on page load
      window.addEventListener("load", function () {
        checkStaffAccess();
        setupEventListeners();
      });

function checkStaffAccess() {
    if (!isStaffLoggedIn) {
        document.getElementById("mainContent").style.display = "none";
        document.getElementById("accessDenied").style.display = "block";
        document.getElementById("staffBtnText").textContent = "Staff Login";
    } else {
        document.getElementById("mainContent").style.display = "block";
        document.getElementById("accessDenied").style.display = "none";
        document.getElementById("staffBtnText").textContent = "✅ Logged In";
        loadApplications();
    }
    lucide.createIcons();
}

      async function loadApplications() {
        try {
          document.getElementById("loadingState").style.display = "block";
          document.getElementById("applicationsList").style.display = "none";
          document.getElementById("noApplications").style.display = "none";

          const applicationsRef = window.firebaseRef(
            window.firebaseDB,
            "applications",
          );
          const snapshot = await window.firebaseGet(applicationsRef);

          if (snapshot.exists()) {
            const data = snapshot.val();
            applications = Object.values(data);
          } else {
            applications = [];
          }

          document.getElementById("loadingState").style.display = "none";
          renderApplications(applications);
          updateCounts();
        } catch (error) {
          console.error("Error loading applications:", error);
          document.getElementById("loadingState").style.display = "none";
          applications = [];
          renderApplications(applications);
          updateCounts();
        }
      }

      function updateCounts() {
        const total = applications.length;
        const approved = applications.filter(
          (app) => app.status === "approved",
        ).length;
        const pending = applications.filter(
          (app) => app.status === "pending",
        ).length;

        document.getElementById("totalApplications").textContent = total;
        document.getElementById("approvedCount").textContent = approved;
        document.getElementById("pendingCount").textContent = pending;
      }

      function filterApplications() {
        const searchTerm = document
          .getElementById("search")
          .value.toLowerCase();
        const filterValue = document.getElementById("filterSelect").value;

        let filtered = applications.filter((app) => {
          const matchesSearch =
            (app.applicationCode &&
              app.applicationCode.toLowerCase().includes(searchTerm)) ||
            (app.legalName && app.legalName.toLowerCase().includes(searchTerm));

          let matchesFilter = true;
          switch (filterValue) {
            case "starred":
              matchesFilter = app.starred === true;
              break;
            case "pending":
              matchesFilter = app.status === "pending";
              break;
            case "approved":
              matchesFilter = app.status === "approved";
              break;
            case "rejected":
              matchesFilter = app.status === "rejected";
              break;
          }

          return matchesSearch && matchesFilter;
        });

        renderApplications(filtered);
      }

      function renderApplications(apps) {
        const container = document.getElementById("applicationsList");
        const noAppsMessage = document.getElementById("noApplications");

        if (apps.length === 0) {
          container.style.display = "none";
          noAppsMessage.style.display = "block";
          return;
        }

        container.style.display = "block";
        noAppsMessage.style.display = "none";

        container.innerHTML = apps
          .map(
            (app) => `
                <div class="application-card p-8">
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                    <i data-lucide="building" class="h-5 w-5 text-blue-600"></i>
                                </div>
                                <h3 class="text-xl font-bold text-gray-900">${app.legalName || "Company Name"}</h3>
                            </div>
                            <p class="text-sm text-gray-600 font-mono bg-gray-100 inline-block px-3 py-1 rounded-lg">
                                📋 ${app.applicationCode}
                            </p>
                        </div>
                        <div class="flex items-center space-x-3">
                            ${getEnhancedStatusBadge(app.status)}
                            <div class="flex items-center space-x-2">
                                <div onclick="toggleApproval('${app.applicationCode}')" 
                                     class="approval-checkbox ${app.status === "approved" ? "checked" : ""}" 
                                     title="${app.status === "approved" ? "Click to mark as pending" : "Click to approve"}">
                                </div>
                                <button onclick="toggleStar('${app.applicationCode}')" 
                                        class="action-button hover:bg-yellow-50 border-yellow-200" 
                                        title="${app.starred ? "Remove from favorites" : "Add to favorites"}">
                                    <i data-lucide="star" class="h-5 w-5 ${app.starred ? "star-filled" : "star-empty"}"></i>
                                </button>
                                <button onclick="downloadComprehensivePDF('${app.applicationCode}')" 
                                        class="action-button hover:bg-blue-50 border-blue-200 text-blue-600" 
                                        title="Download Complete PDF">
                                    <i data-lucide="download" class="h-5 w-5"></i>
                                </button>
                                <button onclick="deleteApplication('${app.applicationCode}')" 
                                        class="action-button hover:bg-red-50 border-red-200 text-red-600" 
                                        title="Delete Application">
                                    <i data-lucide="trash-2" class="h-5 w-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 border border-green-200">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                    <i data-lucide="dollar-sign" class="h-4 w-4 text-white"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-green-800">Loan Amount</p>
                                    <p class="text-sm text-green-700 font-mono">${app.loanAmount || "N/A"}</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 border border-blue-200">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                    <i data-lucide="calendar" class="h-4 w-4 text-white"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-blue-800">Submitted</p>
                                    <p class="text-sm text-blue-700">${formatDate(app.submittedAt)}</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 border border-purple-200">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center">
                                    <i data-lucide="phone" class="h-4 w-4 text-white"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-purple-800">Phone</p>
                                    <p class="text-sm text-purple-700">${app.phoneNumber || "N/A"}</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-4 border border-orange-200">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center">
                                    <i data-lucide="mail" class="h-4 w-4 text-white"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-orange-800">Email</p>
                                    <p class="text-sm text-orange-700 truncate" title="${app.email || "N/A"}">${app.email || "N/A"}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center space-y-2 lg:space-y-0">
                            <div class="flex items-center space-x-4">
                                <span class="text-sm font-semibold text-gray-700">🎯 Purpose:</span>
                                <span class="text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-lg">${(app.purpose || "N/A").substring(0, 60)}${(app.purpose || "").length > 60 ? "..." : ""}</span>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="text-sm font-semibold text-gray-700">📅 Repayment:</span>
                                <span class="text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-lg">${app.repaymentPeriod || "N/A"} months</span>
                            </div>
                        </div>
                    </div>
                </div>
            `,
          )
          .join("");

        // Re-initialize Lucide icons for new content
        lucide.createIcons();
      }

      function getEnhancedStatusBadge(status) {
        switch (status) {
          case "approved":
            return '<span class="status-badge bg-gradient-to-r from-green-500 to-green-600 text-white">✅ Approved</span>';
          case "rejected":
            return '<span class="status-badge bg-gradient-to-r from-red-500 to-red-600 text-white">❌ Rejected</span>';
          default:
            return '<span class="status-badge bg-gradient-to-r from-yellow-500 to-yellow-600 text-white">⏳ Pending</span>';
        }
      }

      function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString("en-IN", {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      async function toggleStar(applicationCode) {
        try {
          const app = applications.find(
            (a) => a.applicationCode === applicationCode,
          );
          if (!app) return;

          const newStarredValue = !app.starred;
          const applicationRef = window.firebaseRef(
            window.firebaseDB,
            `applications/${applicationCode}`,
          );
          await window.firebaseUpdate(applicationRef, {
            starred: newStarredValue,
          });

          app.starred = newStarredValue;
          filterApplications();
        } catch (error) {
          console.error("Error updating star status:", error);
          alert("❌ Error updating favorite status");
        }
      }

      async function toggleApproval(applicationCode) {
        try {
          const app = applications.find(
            (a) => a.applicationCode === applicationCode,
          );
          if (!app) return;

          const newStatus = app.status === "approved" ? "pending" : "approved";
          const applicationRef = window.firebaseRef(
            window.firebaseDB,
            `applications/${applicationCode}`,
          );
          await window.firebaseUpdate(applicationRef, { status: newStatus });

          app.status = newStatus;
          filterApplications();
          updateCounts();
        } catch (error) {
          console.error("Error updating approval status:", error);
          alert("❌ Error updating approval status");
        }
      }

      async function deleteApplication(applicationCode) {
        currentApplicationToDelete = applicationCode;
        document.getElementById("deleteModal").classList.add("show");
      }

      function downloadComprehensivePDF(applicationCode) {
        const app = applications.find(
          (a) => a.applicationCode === applicationCode,
        );
        if (!app) {
          alert("❌ Application not found");
          return;
        }

        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          // PDF Title and Header
          doc.setFontSize(24);
          doc.setFont(undefined, "bold");
          doc.text("FinanceFlow", 20, 25);

          doc.setFontSize(18);
          doc.setFont(undefined, "bold");
          doc.text("BUSINESS LOAN APPLICATION REPORT", 20, 35);

          doc.setFontSize(10);
          doc.setFont(undefined, "normal");
          doc.text(
            `Generated on: ${new Date().toLocaleDateString("en-IN")} at ${new Date().toLocaleTimeString("en-IN")}`,
            20,
            45,
          );

          let y = 60;

          // Application Information
          doc.setFontSize(14);
          doc.setFont(undefined, "bold");
          doc.text("APPLICATION INFORMATION", 20, y);
          y += 10;

          doc.setFontSize(10);
          doc.setFont(undefined, "normal");
          doc.text(`Application Code: ${app.applicationCode || "N/A"}`, 20, y);
          doc.text(
            `Status: ${(app.status || "Pending").toUpperCase()}`,
            120,
            y,
          );
          y += 6;
          doc.text(`Submitted Date: ${formatDate(app.submittedAt)}`, 20, y);
          doc.text(`Starred: ${app.starred ? "YES" : "NO"}`, 120, y);
          y += 6;
          doc.text(
            `Google Form Completed: ${app.googleFormCompleted ? "YES" : "NO"}`,
            20,
            y,
          );

          // Approval Status Box
          y += 15;
          doc.setFontSize(12);
          doc.setFont(undefined, "bold");
          doc.text("APPROVAL STATUS:", 20, y);
          y += 8;

          // Draw approval checkbox
          doc.rect(20, y - 4, 5, 5);
          if (app.status === "approved") {
            doc.setFont(undefined, "bold");
            doc.text("✓", 21.5, y);
          }
          doc.setFont(undefined, "normal");
          doc.text(
            "APPROVED - This application has been reviewed and approved for processing",
            30,
            y,
          );

          y += 15;

          // Company Information Section
          doc.setFontSize(14);
          doc.setFont(undefined, "bold");
          doc.text("1. COMPANY INFORMATION", 20, y);
          y += 10;

          doc.setFontSize(10);
          doc.setFont(undefined, "normal");
          doc.text(`Company Legal Name: ${app.legalName || "N/A"}`, 20, y);
          y += 6;
          doc.text(`Trade Name: ${app.tradeName || "N/A"}`, 20, y);
          y += 6;
          doc.text(`CIN/LLPIN: ${app.cin || "N/A"}`, 20, y);
          y += 6;
          doc.text(
            `Date of Incorporation: ${app.dateOfIncorporation || "N/A"}`,
            20,
            y,
          );
          y += 6;
          doc.text(`Phone Number: ${app.phoneNumber || "N/A"}`, 20, y);
          y += 6;
          doc.text(`Email Address: ${app.email || "N/A"}`, 20, y);
          y += 8;

          // Address
          doc.text("Registered Address:", 20, y);
          y += 6;
          if (app.registeredAddress) {
            const addressLines = app.registeredAddress.match(/.{1,70}/g) || [
              app.registeredAddress,
            ];
            addressLines.forEach((line) => {
              doc.text(line, 25, y);
              y += 6;
            });
          } else {
            doc.text("N/A", 25, y);
            y += 6;
          }

          doc.text(`City: ${app.city || "N/A"}`, 20, y);
          doc.text(`State: ${app.state || "N/A"}`, 80, y);
          y += 6;
          doc.text(`ZIP Code: ${app.zipCode || "N/A"}`, 20, y);
          doc.text(`Country: ${app.country || "N/A"}`, 80, y);
          y += 15;

          // Director Details Section
          doc.setFontSize(14);
          doc.setFont(undefined, "bold");
          doc.text("2. DIRECTOR DETAILS", 20, y);
          y += 10;

          // Director 1
          doc.setFontSize(12);
          doc.setFont(undefined, "bold");
          doc.text("Director 1:", 20, y);
          y += 8;
          doc.setFontSize(10);
          doc.setFont(undefined, "normal");
          doc.text(`Name: ${app.director1Name || "N/A"}`, 20, y);
          y += 6;
          doc.text(`PAN: ${app.director1Pan || "N/A"}`, 20, y);
          doc.text(`Aadhaar: ${app.director1Aadhaar || "N/A"}`, 100, y);
          y += 6;
          doc.text(`DIN: ${app.director1Din || "N/A"}`, 20, y);
          y += 6;
          doc.text("Address:", 20, y);
          y += 6;
          if (app.director1Address) {
            const dir1AddressLines = app.director1Address.match(/.{1,70}/g) || [
              app.director1Address,
            ];
            dir1AddressLines.forEach((line) => {
              doc.text(line, 25, y);
              y += 6;
            });
          } else {
            doc.text("N/A", 25, y);
            y += 6;
          }

          // Director 2
          y += 8;
          doc.setFontSize(12);
          doc.setFont(undefined, "bold");
          doc.text("Director 2:", 20, y);
          y += 8;
          doc.setFontSize(10);
          doc.setFont(undefined, "normal");
          doc.text(`Name: ${app.director2Name || "N/A"}`, 20, y);
          y += 6;
          doc.text(`PAN: ${app.director2Pan || "N/A"}`, 20, y);
          doc.text(`Aadhaar: ${app.director2Aadhaar || "N/A"}`, 100, y);
          y += 6;
          doc.text(`DIN: ${app.director2Din || "N/A"}`, 20, y);
          y += 6;
          doc.text("Address:", 20, y);
          y += 6;
          if (app.director2Address) {
            const dir2AddressLines = app.director2Address.match(/.{1,70}/g) || [
              app.director2Address,
            ];
            dir2AddressLines.forEach((line) => {
              doc.text(line, 25, y);
              y += 6;
            });
          } else {
            doc.text("N/A", 25, y);
            y += 6;
          }

          // Check if we need a new page
          if (y > 250) {
            doc.addPage();
            y = 20;
          }

          // Financial Information Section
          y += 15;
          doc.setFontSize(14);
          doc.setFont(undefined, "bold");
          doc.text("3. FINANCIAL INFORMATION", 20, y);
          y += 10;

          doc.setFontSize(10);
          doc.setFont(undefined, "normal");
          doc.text(`Annual Revenue: ${app.annualRevenue || "N/A"}`, 20, y);
          y += 6;
          doc.text(`PAT (Profit After Tax): ${app.pat || "N/A"}`, 20, y);
          y += 6;
          doc.text(`Capital Employed: ${app.capitalEmployed || "N/A"}`, 20, y);
          y += 6;
          doc.text(
            `Net Profit Margin (%): ${app.netProfitMargin || "N/A"}`,
            20,
            y,
          );
          y += 6;
          doc.text(
            `DSCR (Debt Service Coverage Ratio): ${app.dscr || "N/A"}`,
            20,
            y,
          );
          y += 6;
          doc.text(
            `Current Asset to Liability Ratio: ${app.currentAssetToLiability || "N/A"}`,
            20,
            y,
          );
          y += 15;

          // Loan Details Section
          doc.setFontSize(14);
          doc.setFont(undefined, "bold");
          doc.text("4. LOAN DETAILS", 20, y);
          y += 10;

          doc.setFontSize(10);
          doc.setFont(undefined, "normal");
          doc.text(`Loan Amount: ${app.loanAmount || "N/A"}`, 20, y);
          y += 6;
          doc.text(
            `Repayment Period: ${app.repaymentPeriod || "N/A"} months`,
            20,
            y,
          );
          y += 8;
          doc.text("Purpose:", 20, y);
          y += 6;
          if (app.purpose) {
            const purposeLines = app.purpose.match(/.{1,75}/g) || [app.purpose];
            purposeLines.forEach((line) => {
              doc.text(line, 25, y);
              y += 6;
            });
          } else {
            doc.text("N/A", 25, y);
            y += 6;
          }

          y += 6;
          doc.text("Collateral:", 20, y);
          y += 6;
          if (app.collateral && app.collateral.trim()) {
            const collateralLines = app.collateral.match(/.{1,75}/g) || [
              app.collateral,
            ];
            collateralLines.forEach((line) => {
              doc.text(line, 25, y);
              y += 6;
            });
          } else {
            doc.text("None specified", 25, y);
            y += 6;
          }

          // Declarations Section
          y += 15;
          doc.setFontSize(14);
          doc.setFont(undefined, "bold");
          doc.text("5. DECLARATIONS", 20, y);
          y += 10;

          doc.setFontSize(10);
          doc.setFont(undefined, "normal");
          doc.text(
            "☑ Applicant certifies that all information provided is accurate and complete",
            20,
            y,
          );
          y += 6;
          doc.text(
            "☑ Applicant authorizes verification of the provided information",
            20,
            y,
          );
          y += 6;
          doc.text(
            "☑ Applicant understands that submission does not guarantee approval",
            20,
            y,
          );
          y += 15;

          // Footer
          doc.setFontSize(8);
          doc.setFont(undefined, "normal");
          doc.text(
            "This document was generated automatically by FinanceFlow Application Management System.",
            20,
            y,
          );
          y += 4;
          doc.text(`Document ID: ${app.applicationCode}`, 20, y);
          y += 4;
          doc.text(
            `Report Generated: ${new Date().toLocaleString("en-IN")}`,
            20,
            y,
          );

          // Save the PDF
          doc.save(
            `FinanceFlow_Complete_Application_${app.applicationCode}.pdf`,
          );
        } catch (error) {
          console.error("Error generating PDF:", error);
          alert("❌ Error generating PDF. Please try again.");
        }
      }

      function setupEventListeners() {
        document
          .getElementById("search")
          .addEventListener("input", filterApplications);
        document
          .getElementById("filterSelect")
          .addEventListener("change", filterApplications);
        document
          .getElementById("refreshBtn")
          .addEventListener("click", loadApplications);

        document
          .getElementById("staffLoginBtn")
          .addEventListener("click", function () {
            if (!isStaffLoggedIn) {
              document.getElementById("staffLoginModal").classList.add("show");
            }
          });

        document
          .getElementById("staffLoginFromDenied")
          .addEventListener("click", function () {
            document.getElementById("staffLoginModal").classList.add("show");
          });

        document
          .getElementById("closeModal")
          .addEventListener("click", function () {
            document.getElementById("staffLoginModal").classList.remove("show");
          });

        document
          .getElementById("staffLoginForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            const staffId = document.getElementById("staffId").value;
            const password = document.getElementById("password").value;

            if (staffId === "admin" && password === "password") {
              isStaffLoggedIn = true;
              localStorage.setItem("staffLoggedIn", "true");
              localStorage.setItem("staffLoginTime", new Date().toISOString());
              document
                .getElementById("staffLoginModal")
                .classList.remove("show");
              checkStaffAccess();
            } else {
              alert("❌ Invalid credentials");
            }
          });

        // MODIFIED LOGOUT BUTTON EVENT LISTENER
        document
            .getElementById("logoutBtn")
            .addEventListener("click", function () {
                localStorage.removeItem("staffLoggedIn");
                localStorage.removeItem("staffLoginTime");
                isStaffLoggedIn = false; // Update the global variable

                // Update the Staff Login button text in the header immediately
                document.getElementById("staffBtnText").textContent = "Staff Login";
                
                // Redirect to the homepage (index.html)
                window.location.href = "index.html"; 
            });

        document
          .getElementById("confirmDelete")
          .addEventListener("click", async function () {
            if (currentApplicationToDelete) {
              try {
                const applicationRef = window.firebaseRef(
                  window.firebaseDB,
                  `applications/${currentApplicationToDelete}`,
                );
                await window.firebaseRemove(applicationRef);

                applications = applications.filter(
                  (app) => app.applicationCode !== currentApplicationToDelete,
                );
                filterApplications();
                updateCounts();

                document.getElementById("deleteModal").classList.remove("show");
                currentApplicationToDelete = null;
                alert("✅ Application deleted successfully");
              } catch (error) {
                console.error("Error deleting application:", error);
                alert("❌ Error deleting application");
              }
            }
          });

        document
          .getElementById("cancelDelete")
          .addEventListener("click", function () {
            document.getElementById("deleteModal").classList.remove("show");
            currentApplicationToDelete = null;
          });

        window.addEventListener("click", function (e) {
          if (e.target.classList.contains("modal")) {
            e.target.classList.remove("show");
          }
        });
      }
    </script>
  </body>
</html>