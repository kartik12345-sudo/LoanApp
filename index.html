<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loan Application System</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(to bottom right, #EFF6FF, #DBEAFE);
      min-height: 100vh;
    }

    .header {
      background-color: #1E40AF;
      color: white;
      padding: 1.25rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .header-content {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 1rem;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.5rem;
      font-weight: bold;
    }

    .nav {
      display: flex;
      gap: 1.5rem;
    }

    .nav a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      cursor: pointer; /* Make it look clickable */
      transition: color 0.2s;
    }

    .nav a:hover {
      color: #BFDBFE;
    }

    .container {
      max-width: 1280px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
    }

    .form-input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #D1D5DB;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #2563EB;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1E40AF;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #E5E7EB;
    }

    .btn {
      background-color: #2563EB;
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.375rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .btn:hover {
      background-color: #1D4ED8;
    }

    .btn-danger {
      background-color: #EF4444;
      color: white;
    }

    .btn-danger:hover {
      background-color: #DC2626;
    }

    .message {
      padding: 1rem;
      border-radius: 0.375rem;
      margin-bottom: 1rem;
    }

    .message.success {
      background-color: #D1FAE5;
      color: #065F46;
    }

    .message.error {
      background-color: #FEE2E2;
      color: #991B1B;
    }

    .application-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .application-card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }

    .application-header {
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #F9FAFB;
      border-bottom: 1px solid #E5E7EB;
      cursor: pointer;
    }

    .application-content {
      padding: 1rem;
      display: none;
    }

    .application-content.show {
      display: block;
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
      background-color: #DBEAFE;
      color: #1E40AF;
    }

    .checkbox-group {
      margin-bottom: 1rem;
    }

    .checkbox-label {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #374151;
    }

    .checkbox-input {
      margin-top: 0.25rem;
    }

    .login-container {
      max-width: 400px;
      margin: 4rem auto;
      padding: 2rem;
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .login-title {
      text-align: center;
      color: #1E40AF;
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 2rem;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .pdf-content-viewer {
        /* This is for the content that will be converted to PDF */
        border: 1px solid #E5E7EB;
        padding: 1rem;
        background-color: #F9FAFB;
        border-radius: 0.375rem;
        margin-top: 1rem;
    }

    .pdf-content-viewer p {
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: #374151;
    }

    .pdf-content-viewer strong {
        color: #1E40AF;
    }

    @media (max-width: 640px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .header-content {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }
      
      .nav {
        flex-direction: column;
        gap: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div id="main-content">
    <header class="header">
      <div class="header-content">
        <div class="logo">
          üè¢ FinanceFlow
        </div>
        <nav class="nav">
          <a onclick="showForm()">Apply for Loan</a>
          <a onclick="showApplications()">View Applications</a>
        </nav>
      </div>
    </header>

    <main class="container">
      <div id="form-section" style="display: block;">
        <div id="message" style="display: none;"></div>
        <div class="card">
          <h1 class="section-title">Business Loan Application Form</h1>
          <div style="margin-bottom: 1rem;">
            <p class="form-label" style="font-weight: 600;">Your Application Code: <span id="loan-code-display" style="color: #2563EB;">Loading...</span></p>
          </div>
          <form id="loan-form" onsubmit="submitForm(event)">
            <!-- Company Information -->
            <div class="form-section">
              <h2 class="section-title">1. Company Information</h2>
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">Company Legal Name *</label>
                  <input required name="company_name" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Trade Name</label>
                  <input name="trade_name" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">CIN/LLPIN *</label>
                  <input required name="registration_number" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Date of Incorporation *</label>
                  <input required type="date" name="incorporation_date" class="form-input">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Registered Address *</label>
                <textarea required name="registered_address" class="form-input" rows="3"></textarea>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">City *</label>
                  <input required name="city" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">State *</label>
                  <input required name="state" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">ZIP Code *</label>
                  <input required name="zip_code" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Country *</label>
                  <input required name="country" value="India" class="form-input">
                </div>
              </div>
            </div>

            <!-- Director Details -->
            <div class="form-section">
              <h2 class="section-title">2. Director Details</h2>
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">Director 1 Name *</label>
                  <input required name="director1_name" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Director 1 PAN *</label>
                  <input required name="director1_pan" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Director 1 Aadhaar *</label>
                  <input required name="director1_aadhar" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Director 1 DIN *</label>
                  <input required name="director1_din" class="form-input">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Director 1 Address *</label>
                <textarea required name="director1_address" class="form-input" rows="3"></textarea>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">Director 2 Name *</label>
                  <input required name="director2_name" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Director 2 PAN *</label>
                  <input required name="director2_pan" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Director 2 Aadhaar *</label>
                  <input required name="director2_aadhar" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Director 2 DIN *</label>
                  <input required name="director2_din" class="form-input">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Director 2 Address *</label>
                <textarea required name="director2_address" class="form-input" rows="3"></textarea>
              </div>
            </div>

            <!-- Financial Information -->
            <div class="form-section">
              <h2 class="section-title">3. Financial Information</h2>
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">Annual Revenue *</label>
                  <input required type="number" name="annual_revenue" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">PAT *</label>
                  <input required type="number" name="pat" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Capital Employed *</label>
                  <input required type="number" name="capital_employed" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Net Profit Margin (%) *</label>
                  <input required type="number" step="0.01" name="net_profit_margin" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">DSCR *</label>
                  <input required type="number" step="0.01" name="dscr" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Current Asset to Liability *</label>
                  <input required type="number" step="0.01" name="current_asset_to_liability" class="form-input">
                </div>
              </div>
            </div>

            <!-- Loan Details -->
            <div class="form-section">
              <h2 class="section-title">4. Loan Details</h2>
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">Loan Amount *</label>
                  <input required type="number" name="loan_amount" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Purpose *</label>
                  <input required name="loan_purpose" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Repayment Period (months) *</label>
                  <input required type="number" name="repayment_period" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Collateral</label>
                  <input name="collateral" class="form-input">
                </div>
              </div>
            </div>

            <!-- Declarations -->
            <div class="form-section">
              <h2 class="section-title">5. Declarations</h2>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input required type="checkbox" name="declaration1" class="checkbox-input">
                  I certify that all information provided is accurate and complete
                </label>
              </div>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input required type="checkbox" name="declaration2" class="checkbox-input">
                  I authorize verification of the provided information
                </label>
              </div>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input required type="checkbox" name="declaration3" class="checkbox-input">
                  I understand that submission does not guarantee approval
                </label>
              </div>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
              <button type="submit" class="btn">Submit Application</button>
            </div>
          </form>
        </div>
      </div>

      <div id="applications-section" style="display: none;">
        <div id="login-section">
          <div class="login-container">
            <h2 class="login-title">Staff Login</h2>
            <form id="login-form" class="login-form" onsubmit="handleLogin(event)">
              <div class="form-group">
                <label class="form-label">Staff ID</label>
                <input type="text" id="staff-id" class="form-input" required>
              </div>
              <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="staff-password" class="form-input" required>
              </div>
              <button type="submit" class="btn">Login</button>
            </form>
            <div id="login-message" class="message error" style="display: none; margin-top: 1rem;"></div>
          </div>
        </div>

        <div id="applications-viewer" style="display: none;">
            <div class="card">
                <h1 class="section-title">Submitted Applications</h1>
                <div id="applications-list" class="application-list"></div>
            </div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"; // Added getAnalytics import
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, onSnapshot, doc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables for Firebase services
    let app, analytics, auth, db; // Added analytics variable
    let currentUserId = null;
    let firebaseReady = false; // Flag to track Firebase initialization readiness

    // Use the specific firebaseConfig provided by the user
    const firebaseConfig = {
      apiKey: "AIzaSyBIIjb6cX-li0NghqRtZ0lzRE2IO4v4MoQ",
      authDomain: "loanappapi.firebaseapp.com",
      databaseURL: "https://loanappapi-default-rtdb.firebaseio.com",
      projectId: "loanappapi",
      storageBucket: "loanappapi.firebasestorage.app",
      messagingSenderId: "879738907563",
      appId: "1:879738907563:web:05d15179b6a97a1f0140ee",
      measurementId: "G-NJTEPTQ27V"
    };

    // Use the Canvas environment's __app_id for Firestore path consistency with security rules
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    // The initialAuthToken is provided by the Canvas environment for custom token sign-in
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    /**
     * Initializes Firebase services (App, Auth, Firestore, Analytics).
     * This function ensures all necessary Firebase SDKs are ready before use.
     */
    function initializeFirebase() {
      if (!app) { // Initialize only once
        app = initializeApp(firebaseConfig);
        analytics = getAnalytics(app); // Initialize Analytics
        auth = getAuth(app);
        db = getFirestore(app);
        firebaseReady = true; // Mark Firebase as ready

        // Subscribe to auth state changes to set currentUserId and react to login status
        onAuthStateChanged(auth, async (user) => {
          if (user) {
            currentUserId = user.uid;
            console.log("Firebase authenticated. User ID:", currentUserId);
            // If the applications viewer is currently intended to be visible (i.e., staff logged in),
            // then load applications.
            if (document.getElementById('applications-section').style.display === 'block' &&
                document.getElementById('applications-viewer').style.display === 'block') {
                loadApplications();
            }
          } else {
            currentUserId = null; // Clear user ID if logged out
            console.log("Firebase auth state changed: No user.");
            // Attempt anonymous sign-in if no custom token is available
            try {
                if (!initialAuthToken) {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error('Error during anonymous sign-in:', error.message);
                showMessage('Error authenticating anonymously: ' + error.message, 'error');
            }
          }
        });

        // Attempt custom token sign-in using the Canvas provided token if available
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch((error) => {
                console.error("Error signing in with custom token:", error);
                showMessage("Failed to sign in automatically. Please log in manually (staff login).", "error");
            });
        }
      }
    }

    // Call initializeFirebase when the window loads to ensure Firebase is ready
    window.onload = initializeFirebase;

    // Initial display logic: show the form section by default on page load
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('main-content').style.display = 'block'; // Ensure main content is visible
        window.showForm(); // Show the form section initially
    });

    /**
     * Shows a message to the user.
     * @param {string} message - The message to display.
     * @param {'success'|'error'} type - The type of message (success or error).
     */
    function showMessage(message, type) {
      const messageEl = document.getElementById('message');
      if (messageEl) {
        messageEl.textContent = message;
        messageEl.className = `message ${type}`;
        messageEl.style.display = 'block';
        setTimeout(() => messageEl.style.display = 'none', 5000);
      }
    }

    /**
     * Shows a message specifically for the login section.
     * @param {string} message - The message to display.
     * @param {'success'|'error'} type - The type of message (success or error).
     */
    function showLoginMessage(message, type) {
      const messageEl = document.getElementById('login-message');
      if (messageEl) {
        messageEl.textContent = message;
        messageEl.className = `message ${type}`;
        messageEl.style.display = 'block';
        setTimeout(() => messageEl.style.display = 'none', 5000);
      }
    }

    /**
     * Helper function to wait for Firebase to be ready.
     * @returns {Promise<void>} A promise that resolves when Firebase is ready.
     */
    async function waitForFirebaseReady() {
        while (!firebaseReady || !db || !auth) {
            console.log("Waiting for Firebase to be fully initialized...");
            await new Promise(resolve => setTimeout(resolve, 50)); // Wait 50ms
        }
    }

    /**
     * Generates the next 10-digit loan application number.
     * Waits for Firebase to be ready.
     * @returns {Promise<string>} - A promise that resolves with the next 10-digit loan number.
     */
    async function getNextLoanNumber() {
      await waitForFirebaseReady(); // Ensure Firebase is ready

      try {
        const snapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/loanApplications`));
        return String(snapshot.size + 1).padStart(10, '0');
      } catch (error) {
        console.error("Error getting next loan number:", error);
        showMessage("Could not generate loan code. Please refresh or check console.", "error");
        return '0000000000'; // Fallback in case of error
      }
    }

    /**
     * Displays the form section and updates the loan application code.
     */
    window.showForm = async () => {
      document.getElementById('form-section').style.display = 'block';
      document.getElementById('applications-section').style.display = 'none';
      document.getElementById('applications-viewer').style.display = 'none';
      document.getElementById('login-section').style.display = 'none'; // Ensure login is hidden when applying

      const loanCodeDisplay = document.getElementById('loan-code-display');
      if (loanCodeDisplay) {
          loanCodeDisplay.textContent = 'Generating...';
          const nextCode = await getNextLoanNumber();
          loanCodeDisplay.textContent = nextCode;
      }
    };

    /**
     * Handles the login process.
     * @param {Event} event - The form submission event.
     */
    window.handleLogin = async (event) => {
      event.preventDefault();
      const staffId = document.getElementById('staff-id').value;
      const password = document.getElementById('staff-password').value;

      // Basic hardcoded credentials for demonstration
      if (staffId === 'chandan@3107' && password === '3107@cb') {
        showLoginMessage('Login successful!', 'success');
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('applications-viewer').style.display = 'block';
        loadApplications(); // Load applications after successful login
      } else {
        showLoginMessage('Invalid credentials. Please try again.', 'error');
      }
    };

    /**
     * Displays the applications section, showing login if not authenticated.
     */
    window.showApplications = () => {
      document.getElementById('form-section').style.display = 'none';
      document.getElementById('applications-section').style.display = 'block';

      // Check if user is "authenticated" (i.e., successfully logged in via handleLogin)
      // For this example, we assume if applications-viewer is visible, they are logged in.
      const isLoggedIn = document.getElementById('applications-viewer').style.display === 'block';

      if (isLoggedIn) {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('applications-viewer').style.display = 'block';
        loadApplications();
      } else {
        document.getElementById('login-section').style.display = 'block';
        document.getElementById('applications-viewer').style.display = 'none';
      }
    };

    /**
     * Handles the submission of the loan application form.
     * Waits for Firebase and authentication to be ready.
     * @param {Event} event - The form submission event.
     */
    window.submitForm = async (event) => {
      event.preventDefault();

      await waitForFirebaseReady(); // Ensure Firebase is ready
      // Also ensure a user is authenticated (either anonymously by Canvas or staff login)
      if (!auth.currentUser) {
        showMessage('Authentication in progress. Please wait a moment.', 'error');
        // Optionally, wait for current user to be set if not immediately available
        await new Promise(resolve => {
            const unsubscribe = onAuthStateChanged(auth, user => {
                if (user) {
                    unsubscribe();
                    resolve();
                }
            });
        });
      }

      const form = event.target;
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      try {
        const loanCode = document.getElementById('loan-code-display').textContent;
        // Prevent submission if the loan code is still "Loading..." or "Generating..."
        if (loanCode === 'Loading...' || loanCode === 'Generating...') {
             showMessage('Application code is still generating. Please wait a moment.', 'error');
             return;
        }
        data.loan_reference_number = loanCode; // Use the displayed code
        data.submittedBy = auth.currentUser.uid;
        data.submissionDate = new Date().toISOString();

        await addDoc(collection(db, `artifacts/${appId}/public/data/loanApplications`), data);
        
        showMessage(`Application submitted successfully! Reference Number: ${data.loan_reference_number}`, 'success');
        form.reset();
        // Generate new loan code for next application immediately after submission
        document.getElementById('loan-code-display').textContent = 'Generating...';
        const nextCode = await getNextLoanNumber();
        document.getElementById('loan-code-display').textContent = nextCode;

      } catch (error) {
        showMessage('Error submitting application: ' + error.message, 'error');
        console.error("Error submitting loan application:", error);
      }
    };

    /**
     * Deletes a loan application from Firestore.
     * @param {string} docId - The ID of the document to delete.
     * @param {string} loanRefNumber - The loan reference number for the message.
     */
    window.deleteApplication = async (docId, loanRefNumber) => {
        // Simple confirmation via custom modal later. For now, direct deletion.
        const confirmDelete = confirm(`Are you sure you want to delete application ${loanRefNumber}?`);
        if (!confirmDelete) {
            return;
        }

        await waitForFirebaseReady(); // Ensure Firebase is ready

        try {
            await deleteDoc(doc(db, `artifacts/${appId}/public/data/loanApplications`, docId));
            showMessage(`Application ${loanRefNumber} deleted successfully!`, 'success');
        } catch (error) {
            showMessage(`Error deleting application ${loanRefNumber}: ` + error.message, 'error');
            console.error("Error deleting application:", error);
        }
    };


    /**
     * Loads and displays submitted applications from Firestore.
     * Waits for Firebase to be ready.
     */
    async function loadApplications() {
      await waitForFirebaseReady(); // Ensure Firebase is ready

      const applicationsList = document.getElementById('applications-list');
      applicationsList.innerHTML = '<p style="text-align: center; color: #6B7280;">Loading applications...</p>';

      const q = query(collection(db, `artifacts/${appId}/public/data/loanApplications`), orderBy('loan_reference_number', 'asc'));
      
      // Use onSnapshot for real-time updates
      onSnapshot(q, (snapshot) => {
          applicationsList.innerHTML = ''; // Clear existing list
          
          if (snapshot.empty) {
              applicationsList.innerHTML = '<p style="text-align: center; color: #6B7280;">No applications submitted yet.</p>';
              return;
          }

          snapshot.forEach(doc => {
            const data = doc.data();
            const docId = doc.id;
            const card = document.createElement('div');
            card.className = 'application-card';
            
            const header = document.createElement('div');
            header.className = 'application-header';
            header.innerHTML = `
              <div>
                <div style="font-weight: 500; color: #2563EB;">
                  ${data.loan_reference_number || 'N/A'} View Form
                </div>
                <div style="font-size: 0.875rem; color: #6B7280;">
                  Submitted: ${new Date(data.submissionDate).toLocaleString()}
                </div>
              </div>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <div class="status-badge">Pending Review</div>
                <button class="btn btn-danger" onclick="deleteApplication('${docId}', '${data.loan_reference_number || 'N/A'}')">Delete</button>
              </div>
            `;
            
            const content = document.createElement('div');
            content.className = 'application-content';

            // Prepare content for PDF viewer (text-only)
            const pdfViewerContent = `
                <div id="pdf-viewer-${docId}" class="pdf-content-viewer">
                    <h3 style="font-size: 1.125rem; font-weight: 600; color: #1E40AF; margin-bottom: 1rem;">Loan Application Details (Code: ${data.loan_reference_number})</h3>
                    <p><strong>Company Legal Name:</strong> ${data.company_name || 'N/A'}</p>
                    <p><strong>Trade Name:</strong> ${data.trade_name || 'N/A'}</p>
                    <p><strong>CIN/LLPIN:</strong> ${data.registration_number || 'N/A'}</p>
                    <p><strong>Date of Incorporation:</strong> ${data.incorporation_date || 'N/A'}</p>
                    <p><strong>Registered Address:</strong> ${data.registered_address || 'N/A'}</p>
                    <p><strong>City:</strong> ${data.city || 'N/A'}</p>
                    <p><strong>State:</strong> ${data.state || 'N/A'}</p>
                    <p><strong>ZIP Code:</strong> ${data.zip_code || 'N/A'}</p>
                    <p><strong>Country:</strong> ${data.country || 'N/A'}</p>
                    
                    <h3 style="font-size: 1.125rem; font-weight: 600; color: #1E40AF; margin-top: 1.5rem; margin-bottom: 1rem;">Director Details</h3>
                    <p><strong>Director 1 Name:</strong> ${data.director1_name || 'N/A'}</p>
                    <p><strong>Director 1 PAN:</strong> ${data.director1_pan || 'N/A'}</p>
                    <p><strong>Director 1 Aadhaar:</strong> ${data.director1_aadhar || 'N/A'}</p>
                    <p><strong>Director 1 DIN:</strong> ${data.director1_din || 'N/A'}</p>
                    <p><strong>Director 1 Address:</strong> ${data.director1_address || 'N/A'}</p>
                    <p><strong>Director 2 Name:</strong> ${data.director2_name || 'N/A'}</p>
                    <p><strong>Director 2 PAN:</strong> ${data.director2_pan || 'N/A'}</p>
                    <p><strong>Director 2 Aadhaar:</strong> ${data.director2_aadhar || 'N/A'}</p>
                    <p><strong>Director 2 DIN:</strong> ${data.director2_din || 'N/A'}</p>
                    <p><strong>Director 2 Address:</strong> ${data.director2_address || 'N/A'}</p>

                    <h3 style="font-size: 1.125rem; font-weight: 600; color: #1E40AF; margin-top: 1.5rem; margin-bottom: 1rem;">Financial Information</h3>
                    <p><strong>Annual Revenue:</strong> ‚Çπ${data.annual_revenue || 'N/A'}</p>
                    <p><strong>PAT:</strong> ‚Çπ${data.pat || 'N/A'}</p>
                    <p><strong>Capital Employed:</strong> ‚Çπ${data.capital_employed || 'N/A'}</p>
                    <p><strong>Net Profit Margin (%):</strong> ${data.net_profit_margin || 'N/A'}%</p>
                    <p><strong>DSCR:</strong> ${data.dscr || 'N/A'}</p>
                    <p><strong>Current Asset to Liability:</strong> ${data.current_asset_to_liability || 'N/A'}</p>

                    <h3 style="font-size: 1.125rem; font-weight: 600; color: #1E40AF; margin-top: 1.5rem; margin-bottom: 1rem;">Loan Details</h3>
                    <p><strong>Loan Amount:</strong> ‚Çπ${data.loan_amount || 'N/A'}</p>
                    <p><strong>Purpose:</strong> ${data.loan_purpose || 'N/A'}</p>
                    <p><strong>Repayment Period:</strong> ${data.repayment_period || 'N/A'} months</p>
                    <p><strong>Collateral:</strong> ${data.collateral || 'N/A'}</p>

                    <h3 style="font-size: 1.125rem; font-weight: 600; color: #1E40AF; margin-top: 1.5rem; margin-bottom: 1rem;">Declarations</h3>
                    <p>I certify that all information provided is accurate and complete: <strong>${data.declaration1 ? 'Yes' : 'No'}</strong></p>
                    <p>I authorize verification of the provided information: <strong>${data.declaration2 ? 'Yes' : 'No'}</strong></p>
                    <p>I understand that submission does not guarantee approval: <strong>${data.declaration3 ? 'Yes' : 'No'}</strong></p>
                </div>
                <div style="text-align: right; margin-top: 1rem;">
                    <button class="btn" onclick="generatePdf('${docId}', '${data.loan_reference_number}')">Download PDF</button>
                </div>
            `;
            content.innerHTML = pdfViewerContent;
            
            card.appendChild(header);
            card.appendChild(content);
            
            header.addEventListener('click', () => {
              // Toggle display for the content section
              content.style.display = content.style.display === 'block' ? 'none' : 'block';
            });
            
            applicationsList.appendChild(card);
          });
      }, (error) => {
          console.error("Error fetching real-time applications:", error);
          applicationsList.innerHTML = '<p style="text-align: center; color: #991B1B;">Error loading applications. Please try again.</p>';
      });
    }

    /**
     * Generates a PDF of the application details.
     * @param {string} docId - The ID of the document whose content needs to be converted to PDF.
     * @param {string} loanRefNumber - The loan reference number for the PDF filename.
     */
    window.generatePdf = async (docId, loanRefNumber) => {
        const input = document.getElementById(`pdf-viewer-${docId}`);
        if (!input) {
            console.error("PDF viewer content not found for docId:", docId);
            return;
        }

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'pt', 'a4'); // 'p' for portrait, 'pt' for points, 'a4' for A4 size

        // Get the actual width and height of the A4 page in points
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();

        // Add a loading message
        const downloadButton = input.nextElementSibling.querySelector('.btn');
        const originalButtonText = downloadButton.textContent;
        downloadButton.textContent = 'Generating PDF...';
        downloadButton.disabled = true;

        try {
            const canvas = await html2canvas(input, { scale: 2 }); // Use a higher scale for better quality
            const imgData = canvas.toDataURL('image/png');

            // Calculate dimensions to fit the PDF
            const imgWidth = pdfWidth - 40; // 20pt padding on each side
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            let position = 20; // Initial Y position with padding

            // Check if content fits on one page
            if (imgHeight < pdfHeight - 40) {
                pdf.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
            } else {
                // Multi-page logic
                let heightLeft = imgHeight;
                let pageNum = 1;

                while (heightLeft > 0) {
                    const pageHeight = pdfHeight - 40; // Available height per page after padding
                    let sX = 0; // Source X start for canvas image
                    let sY = (pageNum - 1) * (canvas.height * (pageHeight / imgHeight)); // Source Y start

                    if (pageNum > 1) {
                        pdf.addPage();
                    }

                    // Calculate the crop height for the current page from the canvas
                    const cropHeight = Math.min(heightLeft, pageHeight);
                    const cropCanvas = document.createElement('canvas');
                    cropCanvas.width = canvas.width;
                    cropCanvas.height = Math.min(canvas.height - sY, canvas.height * (pageHeight / imgHeight));

                    const cropCtx = cropCanvas.getContext('2d');
                    cropCtx.drawImage(canvas, sX, sY, cropCanvas.width, cropCanvas.height, 0, 0, cropCanvas.width, cropCanvas.height);
                    
                    pdf.addImage(cropCanvas.toDataURL('image/png'), 'PNG', 20, 20, imgWidth, (cropHeight * imgWidth) / cropCanvas.width);

                    heightLeft -= pageHeight;
                    pageNum++;
                }
            }
            
            pdf.save(`${loanRefNumber}_loan_application.pdf`);
            showMessage(`PDF for ${loanRefNumber} downloaded successfully!`, 'success');
        } catch (error) {
            console.error("Error generating PDF:", error);
            showMessage("Error generating PDF. Please try again.", "error");
        } finally {
            downloadButton.textContent = originalButtonText;
            downloadButton.disabled = false;
        }
    };

  </script>
  
</body>
</html>
